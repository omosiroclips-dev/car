<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚¦ã‚£ãƒ³ã‚«ãƒ¼åˆ¤å®š</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  padding-top: 40px;
}
#state {
  font-size: 2rem;
  margin-top: 30px;
}
button {
  font-size: 1.2rem;
  padding: 12px 24px;
  border-radius: 10px;
  border: none;
}
</style>
</head>

<body>
<h1>ğŸš— ã‚¦ã‚£ãƒ³ã‚«ãƒ¼åˆ¤å®š</h1>
<p>é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
<button onclick="init()">â–¶ é–‹å§‹</button>

<div id="state">å¾…æ©Ÿä¸­</div>

<!-- éŸ³å£° -->
<video id="turnSound" src="uwincar-kachikachi.mp4" playsinline></video>
<video id="endSound" src="uwincar-kachikachi-kanryou.mp4" playsinline></video>

<script>
let startHeading = null;
let turning = false;
let turnDir = null;
let lastAction = 0;

function init() {
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    DeviceOrientationEvent.requestPermission().then(p => {
      if (p === "granted") start();
      else alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™");
    });
  } else {
    start();
  }
}

function start() {
  window.addEventListener("deviceorientation", onRotate);
  document.querySelector("button").style.display = "none";
  document.getElementById("state").textContent = "ã‚»ãƒ³ã‚µãƒ¼å¾…æ©Ÿä¸­â€¦";
}

function onRotate(e) {
  if (e.alpha === null) return;

  const now = Date.now();
  if (now - lastAction < 300) return;
  lastAction = now;

  if (startHeading === null) {
    startHeading = e.alpha;
    return;
  }

  let diff = ((e.alpha - startHeading + 540) % 360) - 180;

  // å·¦å³åˆ¤å®š
  if (!turning && Math.abs(diff) > 25) {
    turning = true;
    turnDir = diff > 0 ? "right" : "left";

    document.getElementById("state").textContent =
      turnDir === "left" ? "â¬…ï¸ å·¦æŠ˜ä¸­" : "â¡ï¸ å³æŠ˜ä¸­";

    setTimeout(() => {
      document.getElementById("turnSound").currentTime = 0;
      document.getElementById("turnSound").play();
    }, 1000);
  }

  // çµ‚äº†åˆ¤å®š
  if (turning && Math.abs(diff) < 8) {
    turning = false;
    startHeading = e.alpha;

    document.getElementById("turnSound").pause();
    document.getElementById("turnSound").currentTime = 0;

    document.getElementById("endSound").currentTime = 0;
    document.getElementById("endSound").play();

    document.getElementById("state").textContent = "âœ… æ›²ãŒã‚Šçµ‚ã‚ã‚Š";
  }
}
</script>
</body>
</html>
